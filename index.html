<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace Safety IoT Simulator</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 3. Load Date adapter for Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'safety-red': '#D92D20',
                        'safety-green': '#027A48',
                        'safety-amber': '#F79009',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
        }
        .live-dot {
            width: 12px;
            height: 12px;
            background-color: #10B981;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .live-dot.paused {
            animation: none;
            background-color: #6B7280;
        }
        /* Chart.js responsiveness fix */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        /* New styles for the map */
        .map-container {
            position: relative;
            width: 100%;
            height: 250px;
            background-color: #e2e8f0; /* slate-200 */
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #cbd5e1; /* slate-300 */
            /* Simple grid background */
            background-image:
                linear-gradient(to right, #cbd5e1 1px, transparent 1px),
                linear-gradient(to bottom, #cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .location-dot {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #D92D20; /* safety-red */
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%); /* Center the dot */
            transition: left 1.5s linear, top 1.5s linear;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class="h-full">
    <div class="flex flex-col lg:flex-row min-h-screen">

        <!-- ===== LEFT PANEL: Control & Simulation ===== -->
        <aside class="w-full lg:w-1/3 xl:w-1/4 p-6 bg-slate-100 border-r border-slate-200">
            <h2 class="text-2xl font-bold text-slate-800">IoT Control Panel</h2>
            <p class="text-sm text-slate-600 mb-6">Playback pre-recorded worker data.</p>

            <!-- Worker Selection -->
            <div class="mb-6">
                <label for="workerSelect" class="block text-sm font-medium text-slate-700 mb-2">Select Worker Device</label>
                <select id="workerSelect" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="worker-001">Worker 1 Ramesh kumar</option>
                    <option value="worker-002">Worker 2 Nandlal Mahto</option>
                    <option value="worker-003">Worker 3 Sanjay Kumar</option>
                </select>
            </div>

            <!-- Monitoring Controls -->
            <div class="flex space-x-3 mb-6">
                <button id="startButton" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Play Simulation
                </button>
                <button id="stopButton" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg font-medium shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" disabled>
                    Stop / Reset
                </button>
            </div>

            <!-- Live Data Feed -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-slate-900">Live Vitals</h3>
                    <div id="liveStatus" class="flex items-center space-x-2">
                        <div id="liveDot" class="live-dot paused"></div>
                        <span id="liveText" class="text-sm font-medium text-gray-500">Paused</span>
                    </div>
                </div>
                <!-- Updated grid for 5 items -->
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                        <div class="text-slate-500">Heart Rate</div>
                        <div id="liveBPM" class="text-2xl font-bold text-slate-800">--</div>
                    </div>
                    <div>
                        <div class="text-slate-500">SpO2</div>
                        <div id="liveSpO2" class="text-2xl font-bold text-slate-800">--</div>
                    </div>
                     <div>
                        <div class="text-slate-500">Stress</div>
                        <div id="liveStress" class="text-2xl font-bold text-slate-800">--</div>
                    </div>
                    <div>
                        <div class="text-slate-500">Body Temp</div>
                        <div id="liveTemp" class="text-2xl font-bold text-slate-800">--</div>
                    </div>
                    <div class="col-span-2">
                        <div class="text-slate-500">Location</div>
                        <div class="font-mono text-xs text-slate-800">
                            Lat: <span id="liveLat">--</span>
                        </div>
                        <div class="font-mono text-xs text-slate-800">
                            Lon: <span id="liveLon">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Export -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold text-slate-900 mb-3">Data Export</h3>
                <p class="text-sm text-slate-600 mb-3">Download the complete, fixed dataset for all workers as a JSON file.</p>
                <button id="downloadButton" class="w-full bg-safety-green text-white px-4 py-2 rounded-lg font-medium shadow-sm hover:bg-green-700">
                    Download Data (.json)
                </button>
            </div>
        </aside>

        <!-- ===== RIGHT PANEL: Dashboard & Results ===== -->
        <main class="w-full lg:w-2/3 xl:w-3/4 p-6 lg:p-10">
            <h1 id="dashboardTitle" class="text-3xl font-bold text-slate-900 mb-6">Safety Dashboard: Worker 1 Ramesh kumar</h1>

            <!-- How to Use -->
            <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-8">
                <h4 class="font-bold">How to Use This Simulator</h4>
                <p class="text-sm">
                    1. Select a worker. Their *full data history* will load on the charts.
                    <br>2. Click *"Play Simulation"* to watch the data playback in real-time.
                    <br>3. Click *"Stop / Reset"* to stop playback and clear the charts.
                    <br>4. Take screenshots of this dashboard for your thesis "Results" section.
                    <br>5. Click *"Download Data"* to get the raw JSON for all 3 workers.
                </p>
            </div>

            <!-- Chart Grid -->
            <!-- Updated to 2x2 grid -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
                <!-- Heart Rate Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Heart Rate (BPM)</h3>
                    <div class="chart-container">
                        <canvas id="bpmChart"></canvas>
                    </div>
                </div>
                <!-- SpO2 Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Blood Oxygen (SpO2 %)</h3>
                    <div class="chart-container">
                        <canvas id="spO2Chart"></canvas>
                    </div>
                </div>
                <!-- Body Temp Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Body Temperature (°C)</h3>
                    <div class="chart-container">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>
                <!-- Stress Level Chart -->
                <div classs="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Stress Level</h3>
                    <div class="chart-container">
                        <canvas id="stressChart"></canvas>
                    </div>
                </div>
                 <!-- Live Location Panel -->
                <div class="bg-white rounded-lg shadow p-6 xl:col-span-2">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Live Location</h3>
                    <h4 class="text-sm font-medium text-slate-600 mb-4">Site Location: GSFC Plant, Moti Khavdi</h4>
                    <div class="map-container">
                        <div id="locationDot" class="location-dot"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // === 1. FIXED PRE-RECORDED DATA ===
        // This is the complete, fixed dataset for your thesis.
        // Coordinates are centered on GSFC Plant, Moti Khavdi (approx 22.325° N, 70.015° E)
        const fixedRecordedData = {
            'worker-001': [
                // Day 1: 2024-11-22
                { time: "2024-11-22 09:00:00", bpm: 72, spO2: 98, temp: 36.6, stress: "Low", lat: 22.3242, lon: 70.0132 },
                { time: "2024-11-22 09:00:02", bpm: 74, spO2: 98, temp: 36.6, stress: "Low", lat: 22.3242, lon: 70.0133 },
                { time: "2024-11-22 09:00:04", bpm: 75, spO2: 98, temp: 36.7, stress: "Low", lat: 22.3243, lon: 70.0133 },
                { time: "2024-11-22 09:00:06", bpm: 78, spO2: 97, temp: 36.7, stress: "Low", lat: 22.3243, lon: 70.0134 },
                { time: "2024-11-22 09:00:08", bpm: 80, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3244, lon: 70.0134 },
                { time: "2024-11-22 09:00:10", bpm: 82, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3244, lon: 70.0135 },
                { time: "2024-11-22 09:00:12", bpm: 81, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3245, lon: 70.0135 },
                { time: "2024-11-22 09:00:14", bpm: 85, spO2: 97, temp: 36.9, stress: "Medium", lat: 22.3245, lon: 70.0136 },
                // Day 2: 2024-11-23
                { time: "2024-11-23 09:00:16", bpm: 88, spO2: 97, temp: 36.9, stress: "Medium", lat: 22.3246, lon: 70.0136 },
                { time: "2024-11-23 09:00:18", bpm: 86, spO2: 98, temp: 36.8, stress: "Medium", lat: 22.3246, lon: 70.0137 },
                { time: "2024-11-23 09:00:20", bpm: 84, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3247, lon: 70.0137 },
                { time: "2024-11-23 09:00:22", bpm: 82, spO2: 98, temp: 36.7, stress: "Low", lat: 22.3247, lon: 70.0138 },
                { time: "2024-11-23 09:00:24", bpm: 80, spO2: 99, temp: 36.7, stress: "Low", lat: 22.3248, lon: 70.0138 },
                { time: "2024-11-23 09:00:26", bpm: 79, spO2: 99, temp: 36.7, stress: "Low", lat: 22.3248, lon: 70.0139 },
                { time: "2024-11-23 09:00:28", bpm: 78, spO2: 99, temp: 36.6, stress: "Low", lat: 22.3249, lon: 70.0139 },
                { time: "2024-11-23 09:00:30", bpm: 76, spO2: 98, temp: 36.6, stress: "Low", lat: 22.3249, lon: 70.0140 }
            ],
            'worker-002': [
                // Day 1: 2024-11-25
                { time: "2024-11-25 09:00:00", bpm: 80, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3250, lon: 70.0141 },
                { time: "2024-11-25 09:00:02", bpm: 82, spO2: 98, temp: 36.9, stress: "Low", lat: 22.3250, lon: 70.0142 },
                { time: "2024-11-25 09:00:04", bpm: 85, spO2: 97, temp: 37.0, stress: "Low", lat: 22.3251, lon: 70.0142 },
                { time: "2024-11-25 09:00:06", bpm: 90, spO2: 97, temp: 37.1, stress: "Medium", lat: 22.3251, lon: 70.0143 },
                { time: "2024-11-25 09:00:08", bpm: 95, spO2: 97, temp: 37.2, stress: "Medium", lat: 22.3252, lon: 70.0143 },
                { time: "2024-11-25 09:00:10", bpm: 102, spO2: 96, temp: 37.3, stress: "Medium", lat: 22.3252, lon: 70.0144 },
                { time: "2024-11-25 09:00:12", bpm: 110, spO2: 96, temp: 37.4, stress: "High", lat: 22.3253, lon: 70.0144 },
                { time: "2024-11-25 09:00:14", bpm: 115, spO2: 95, temp: 37.5, stress: "High", lat: 22.3253, lon: 70.0145 },
                // Day 2: 2024-11-26
                { time: "2024-11-26 09:00:16", bpm: 112, spO2: 95, temp: 37.4, stress: "High", lat: 22.3254, lon: 70.0145 },
                { time: "2024-11-26 09:00:18", bpm: 105, spO2: 96, temp: 37.3, stress: "Medium", lat: 22.3254, lon: 70.0146 },
                { time: "2024-11-26 09:00:20", bpm: 100, spO2: 97, temp: 37.2, stress: "Medium", lat: 22.3255, lon: 70.0146 },
                { time: "2024-11-26 09:00:22", bpm: 95, spO2: 97, temp: 37.1, stress: "Low", lat: 22.3255, lon: 70.0147 },
                { time: "2024-11-26 09:00:24", bpm: 92, spO2: 98, temp: 37.0, stress: "Low", lat: 22.3256, lon: 70.0147 },
                { time: "2024-11-26 09:00:26", bpm: 90, spO2: 98, temp: 36.9, stress: "Low", lat: 22.3256, lon: 70.0148 },
                { time: "2024-11-26 09:00:28", bpm: 88, spO2: 98, temp: 36.9, stress: "Low", lat: 22.3257, lon: 70.0148 },
                { time: "2024-11-26 09:00:30", bpm: 86, spO2: 99, temp: 36.8, stress: "Low", lat: 22.3257, lon: 70.0149 }
            ],
            'worker-003': [
                // Day 1: 2024-11-27
                { time: "2024-11-27 09:00:00", bpm: 75, spO2: 99, temp: 36.7, stress: "Low", lat: 22.3245, lon: 70.0136 },
                { time: "2024-11-27 09:00:02", bpm: 74, spO2: 99, temp: 36.7, stress: "Low", lat: 22.3244, lon: 70.0136 },
                { time: "2024-11-27 09:00:04", bpm: 76, spO2: 98, temp: 36.7, stress: "Low", lat: 22.3243, lon: 70.0135 },
                { time: "2024-11-27 09:00:06", bpm: 78, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3242, lon: 70.0135 },
                { time: "2024-11-27 09:00:08", bpm: 80, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3241, lon: 70.0134 },
                { time: "2024-11-27 09:00:10", bpm: 90, spO2: 97, temp: 36.9, stress: "Medium", lat: 22.3240, lon: 70.0134 },
                { time: "2024-11-27 09:00:12", bpm: 88, spO2: 97, temp: 37.0, stress: "Medium", lat: 22.3241, lon: 70.0133 },
                { time: "2024-11-27 09:00:14", bpm: 86, spO2: 98, temp: 36.9, stress: "Medium", lat: 22.3242, lon: 70.0133 },
                // Day 2: 2024-11-28
                { time: "2024-11-28 09:00:16", bpm: 92, spO2: 97, temp: 37.0, stress: "Medium", lat: 22.3243, lon: 70.0132 },
                { time: "2024-11-28 09:00:18", bpm: 95, spO2: 97, temp: 37.1, stress: "Medium", lat: 22.3244, lon: 70.0132 },
                { time: "2024-11-28 09:00:20", bpm: 105, spO2: 96, temp: 37.2, stress: "High", lat: 22.3245, lon: 70.0131 },
                { time: "2024-11-28 09:00:22", bpm: 102, spO2: 96, temp: 37.1, stress: "High", lat: 22.3244, lon: 70.0131 },
                { time: "2024-11-28 09:00:24", bpm: 98, spO2: 97, temp: 37.0, stress: "Medium", lat: 22.3243, lon: 70.0132 },
                { time: "2024-11-28 09:00:26", bpm: 94, spO2: 97, temp: 36.9, stress: "Medium", lat: 22.3242, lon: 70.0132 },
                { time: "2024-1Z-28 09:00:28", bpm: 90, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3241, lon: 70.0133 },
                { time: "2024-11-28 09:00:30", bpm: 88, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3240, lon: 70.0133 }
            ]
        };

        // Bounds of our simulated map for normalization
        const mapBounds = {
            minLat: 22.3240, maxLat: 22.3260,
            minLon: 70.0130, maxLon: 70.0150
        };

        // === 2. STATE MANAGEMENT ===
        let playbackInterval = null;
        let currentDataIndex = 0;
        let selectedWorkerId = 'worker-001';
        let selectedWorkerName = 'Worker 1 Ramesh kumar';
        
        // This object will store the data during playback for charts
        let simulationData = {
            'worker-001': { heartRate: [], spO2: [], temp: [], stress: [] },
            'worker-002': { heartRate: [], spO2: [], temp: [], stress: [] },
            'worker-003': { heartRate: [], spO2: [], temp: [], stress: [] },
        };

        let charts = {}; // To store Chart.js instances

        // Helper function to map stress to a number
        const stressToNum = (stress) => {
            if (stress === "Low") return 1;
            if (stress === "Medium") return 2;
            if (stress === "High") return 3;
            return 0;
        };


        document.addEventListener('DOMContentLoaded', () => {

            // === 3. UI ELEMENTS ===
            const workerSelect = document.getElementById('workerSelect');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const dashboardTitle = document.getElementById('dashboardTitle');
            
            // Live Data UI
            const liveDot = document.getElementById('liveDot');
            const liveText = document.getElementById('liveText');
            const liveBPM = document.getElementById('liveBPM');
            const liveSpO2 = document.getElementById('liveSpO2');
            const liveTemp = document.getElementById('liveTemp');
            const liveLat = document.getElementById('liveLat');
            const liveLon = document.getElementById('liveLon');
            const liveStress = document.getElementById('liveStress');

            // Location Map UI
            const locationDot = document.getElementById('locationDot');

            // Data Export
            const downloadButton = document.getElementById('downloadButton');

            // === 4. CHART INITIALIZATION ===
            function initCharts() {
                // Destroy old charts if they exist
                Object.values(charts).forEach(chart => chart.destroy());

                const commonOptions = (title) => ({
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            type: 'time', // Use time scale
                            time: {
                                tooltipFormat: 'MMM dd, yyyy HH:mm:ss', // Format for the tooltip
                                displayFormats: {
                                    second: 'HH:mm:ss',
                                    minute: 'HH:mm',
                                    hour: 'HH:mm',
                                    day: 'MMM dd' 
                                }
                            },
                            title: { display: true, text: 'Date / Time' },
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 10 // Limit ticks to prevent overlap
                            }
                        },
                        y: { title: { display: true, text: title } }
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    // Custom tooltip title format
                                    const date = new Date(tooltipItems[0].parsed.x);
                                    return date.toLocaleString('en-US', { 
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric', 
                                        hour: '2-digit', 
                                        minute: '2-digit', 
                                        second: '2-digit' 
                                    });
                                }
                            }
                        }
                    },
                    animation: { duration: 500 }
                });

                charts.bpm = new Chart(document.getElementById('bpmChart').getContext('2d'), {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#3B82F6', tension: 0.1, fill: false }] },
                    options: { ...commonOptions('BPM'), scales: { ...commonOptions('BPM').scales, y: { min: 40, max: 130 } } }
                });

                charts.spO2 = new Chart(document.getElementById('spO2Chart').getContext('2d'), {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#10B981', tension: 0.1, fill: false }] },
                    options: { ...commonOptions('SpO2 %'), scales: { ...commonOptions('SpO2 %').scales, y: { min: 90, max: 101 } } }
                });
                
                charts.temp = new Chart(document.getElementById('tempChart').getContext('2d'), {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#F79009', tension: 0.1, fill: false }] },
                    options: { ...commonOptions('Temp °C'), scales: { ...commonOptions('Temp °C').scales, y: { min: 35, max: 39 } } }
                });

                charts.stress = new Chart(document.getElementById('stressChart').getContext('2d'), {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#6B7280', tension: 0.1, fill: false, stepped: true }] },
                    options: { 
                        ...commonOptions('Stress Level'), 
                        scales: { 
                            ...commonOptions('Stress Level').scales, 
                            y: { 
                                min: 0.5, 
                                max: 3.5,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value, index, ticks) {
                                        if (value === 1) return 'Low';
                                        if (value === 2) return 'Medium';
                                        if (value === 3) return 'High';
                                        return '';
                                    }
                                }
                            } 
                        } 
                    }
                });
            }

            // === 5. CORE LOGIC ===

            function startPlayback() {
                if (playbackInterval) return; // Already running

                // Clear current data and charts
                resetSimulation();
                
                // Set UI to "running" state
                startButton.disabled = true;
                stopButton.disabled = false;
                liveDot.classList.remove('paused');
                liveText.textContent = 'Live';
                liveText.classList.remove('text-gray-500');
                liveText.classList.add('text-green-600');

                // Start playback loop
                currentDataIndex = 0;
                playbackInterval = setInterval(playNextDataPoint, 2000); // New data every 2 seconds
            }

            function playNextDataPoint() {
                const workerData = fixedRecordedData[selectedWorkerId];
                
                if (currentDataIndex >= workerData.length) {
                    stopPlayback(); // Reached end of data
                    return;
                }

                const dataPoint = workerData[currentDataIndex];
                
                // --- Store Data for charts ---
                const playbackBuffer = simulationData[selectedWorkerId];
                playbackBuffer.heartRate.push({ x: dataPoint.time, y: dataPoint.bpm });
                playbackBuffer.spO2.push({ x: dataPoint.time, y: dataPoint.spO2 });
                playbackBuffer.temp.push({ x: dataPoint.time, y: dataPoint.temp });
                playbackBuffer.stress.push({ x: dataPoint.time, y: stressToNum(dataPoint.stress) });

                // --- Update Live UI ---
                updateLiveUI(dataPoint);
                
                // --- Update Visuals ---
                updateCharts();
                updateLocationMap(dataPoint.lat, dataPoint.lon);

                currentDataIndex++;
            }
            
            function stopPlayback() {
                clearInterval(playbackInterval);
                playbackInterval = null;

                // Set UI to "paused" state
                startButton.disabled = false;
                stopButton.disabled = true;
                liveDot.classList.add('paused');
                liveText.textContent = 'Paused';
                liveText.classList.add('text-gray-500');
                liveText.classList.remove('text-green-600');
            }
            
            function resetSimulation() {
                stopPlayback();

                // Clear live data display
                updateLiveUI({ bpm: '--', spO2: '--', temp: '--', lat: '--', lon: '--', stress: '--' });

                // Clear simulation data buffer
                simulationData[selectedWorkerId] = { heartRate: [], spO2: [], temp: [], stress: [] };
                
                // Clear charts
                updateCharts();
                locationDot.style.display = 'none';
            }
            
            function updateLiveUI(dataPoint) {
                liveBPM.textContent = dataPoint.bpm;
                liveSpO2.textContent = dataPoint.spO2;
                liveTemp.textContent = dataPoint.temp;
                liveLat.textContent = dataPoint.lat;
                liveLon.textContent = dataPoint.lon;
                liveStress.textContent = dataPoint.stress;

                // Update stress color
                liveStress.classList.remove('text-safety-green', 'text-safety-amber', 'text-safety-red', 'text-slate-800');
                if (dataPoint.stress === "Low") {
                    liveStress.classList.add('text-safety-green');
                } else if (dataPoint.stress === "Medium") {
                    liveStress.classList.add('text-safety-amber');
                } else if (dataPoint.stress === "High") {
                    liveStress.classList.add('text-safety-red');
                } else {
                    liveStress.classList.add('text-slate-800');
                }
            }

            function updateCharts() {
                const playbackBuffer = simulationData[selectedWorkerId];

                // Update BPM Chart
                charts.bpm.data.labels = playbackBuffer.heartRate.map(d => d.x);
                charts.bpm.data.datasets[0].data = playbackBuffer.heartRate.map(d => d.y);
                charts.bpm.update('none'); // 'none' for no animation
                
                // Update SpO2 Chart
                charts.spO2.data.labels = playbackBuffer.spO2.map(d => d.x);
                charts.spO2.data.datasets[0].data = playbackBuffer.spO2.map(d => d.y);
                charts.spO2.update('none');

                // Update Temp Chart
                charts.temp.data.labels = playbackBuffer.temp.map(d => d.x);
                charts.temp.data.datasets[0].data = playbackBuffer.temp.map(d => d.y);
                charts.temp.update('none');

                // Update Stress Chart
                charts.stress.data.labels = playbackBuffer.stress.map(d => d.x);
                charts.stress.data.datasets[0].data = playbackBuffer.stress.map(d => d.y);
                charts.stress.update('none');
            }

            function updateLocationMap(lat, lon) {
                locationDot.style.display = 'block';

                // Normalize coordinates to 0-100% for the map div
                const { minLat, maxLat, minLon, maxLon } = mapBounds;
                let percentX = ((lon - minLon) / (maxLon - minLon)) * 100;
                let percentY = ((lat - minLat) / (maxLat - minLat)) * 100;

                // Clamp to 0-100 to keep dot inside the box
                percentX = Math.max(0, Math.min(100, percentX));
                percentY = Math.max(0, Math.min(100, percentY));

                // Apply style (invert Y-axis: 0% lat = 100% top)
                locationDot.style.left = ${percentX}%;
                locationDot.style.top = ${100 - percentY}%;
            }
            
            // New function to load the full history for a worker onto the charts
            function loadFullHistory(workerId) {
                const workerData = fixedRecordedData[workerId];
                const playbackBuffer = simulationData[workerId];
                
                // Clear any existing data
                playbackBuffer.heartRate = [];
                playbackBuffer.spO2 = [];
                playbackBuffer.temp = [];
                playbackBuffer.stress = [];

                // Populate the buffer with all data
                workerData.forEach(dataPoint => {
                    playbackBuffer.heartRate.push({ x: dataPoint.time, y: dataPoint.bpm });
                    playbackBuffer.spO2.push({ x: dataPoint.time, y: dataPoint.spO2 });
                    playbackBuffer.temp.push({ x: dataPoint.time, y: dataPoint.temp });
                    playbackBuffer.stress.push({ x: dataPoint.time, y: stressToNum(dataPoint.stress) });
                });

                // Update all charts
                updateCharts();
                
                // Update UI to show the last known data point
                const lastDataPoint = workerData[workerData.length - 1];
                updateLiveUI(lastDataPoint);
                updateLocationMap(lastDataPoint.lat, lastDataPoint.lon);
            }

            function switchWorker() {
                resetSimulation(); // Stop playback and clear
                selectedWorkerId = workerSelect.value;
                selectedWorkerName = workerSelect.options[workerSelect.selectedIndex].text;
                
                dashboardTitle.textContent = Safety Dashboard: ${selectedWorkerName};
                
                // Load the full static history for the new worker
                loadFullHistory(selectedWorkerId);
            }
            
            function downloadData() {
                // Download the complete, original fixed dataset
                const dataStr = JSON.stringify(fixedRecordedData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = iot_fixed_worker_data_${new Date().toISOString().split('T')[0]}.json;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // === 6. EVENT LISTENERS ===
            workerSelect.addEventListener('change', switchWorker);
            startButton.addEventListener('click', startPlayback);
            stopButton.addEventListener('click', resetSimulation);
            downloadButton.addEventListener('click', downloadData);

            // === 7. INITIALIZE APP ===
            initCharts();
            loadFullHistory(selectedWorkerId); // Load initial worker's full history
        });
    </script>
</body>
</html>
