<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace Safety IoT Simulator</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 3. LOAD DATE LIBRARIES -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-blue': '#005A9C',
                        'brand-blue-dark': '#003E6B',
                        'brand-blue-light': '#E6F0F6',
                        'safe-green': '#10B981',
                        'warn-yellow': '#F59E0B',
                        'danger-red': '#EF4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom map container styles */
        .map-container {
            position: relative;
            width: 100%;
            height: 200px; /* Fixed height for the map */
            background-color: #E2E8F0; /* Light gray background */
            border-radius: 0.5rem;
            border: 2px dashed #94A3B8;
            overflow: hidden;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            /* Simple grid background */
            background-image: 
                linear-gradient(to right, #CBD5E1 1px, transparent 1px),
                linear-gradient(to bottom, #CBD5E1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .location-dot {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #EF4444; /* danger-red */
            border-radius: 50%;
            border: 2px solid #FFFFFF;
            box-shadow: 0 0 8px 2px #EF4444;
            transform: translate(-50%, -50%); /* Center the dot */
            transition: top 0.5s linear, left 0.5s linear; /* Smooth movement */
        }

        /* Chart container to enforce aspect ratio */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>

<body class="bg-slate-100 font-sans antialiased">

    <!-- Header -->
    <header class="bg-brand-blue shadow-md">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-white text-xl font-bold">IoT Workplace Safety Simulator</span>
                </div>
                <div class="text-white text-sm">
                    M.Tech Thesis Project
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content Grid -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Panel: Controls -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Worker Selection -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Select Worker Device</h3>
                    <select id="workerSelect" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-blue">
                        <option value="">-- Select a Worker --</option>
                        <option value="worker-001">Worker 1 Ramesh kumar</option>
                        <option value="worker-002">Worker 2 Nandlal Mahto</option>
                        <option value="worker-003">Worker 3 Sanjay Kumar</option>
                    </select>

                    <div class="mt-6 flex space-x-4">
                        <button id="playButton" class="w-full bg-brand-blue text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-brand-blue-dark focus:outline-none focus:ring-2 focus:ring-brand-blue focus:ring-opacity-50 transition duration-200" disabled>
                            Play Simulation
                        </button>
                        <button id="stopButton" class="w-full bg-slate-600 text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-opacity-50 transition duration-200" disabled>
                            Stop / Reset
                        </button>
                    </div>
                </div>

                <!-- Live Vitals Panel -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Live Vitals</h3>
                    <div class="flex items-center justify-between mb-4">
                        <span id="statusText" class="text-sm font-medium text-slate-500">Paused</span>
                        <div id="statusIndicator" class="w-4 h-4 rounded-full bg-slate-400 transition-colors duration-300"></div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <span class="text-xs text-slate-500 uppercase">Heart Rate</span>
                            <p id="liveBpm" class="text-3xl font-bold text-slate-800">--</p>
                        </div>
                        <div>
                            <span class="text-xs text-slate-500 uppercase">SpO2</span>
                            <p id="liveSpO2" class="text-3xl font-bold text-slate-800">--</p>
                        </div>
                         <div>
                            <span class="text-xs text-slate-500 uppercase">Stress</span>
                            <p id="liveStress" class="text-xl font-bold text-slate-800">--</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-center mt-6">
                         <div>
                            <span class="text-xs text-slate-500 uppercase">Body Temp</span>
                            <p id="liveTemp" class="text-2xl font-bold text-slate-800">--</p>
                        </div>
                        <div>
                            <span class="text-xs text-slate-500 uppercase">Location</span>
                            <p id="liveLat" class="text-sm font-medium text-slate-800">Lat: --</p>
                            <p id="liveLon" class="text-sm font-medium text-slate-800">Lon: --</p>
                        </div>
                    </div>
                </div>

                <!-- Data Export Panel -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Data Export</h3>
                    <p class="text-sm text-slate-600 mb-4">Download the complete, fixed dataset for all workers as a JSON file.</p>
                    <button id="downloadButton" class="w-full bg-safe-green text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-200">
                        Download Data (.json)
                    </button>
                </div>
            </div>

            <!-- Right Panel: Dashboard -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Instructions -->
                <div class="bg-brand-blue-light border-l-4 border-brand-blue text-brand-blue-dark p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-2">How to Use This Simulator</h3>
                    <ol class="list-decimal list-inside text-sm space-y-1">
                        <li>Select a worker. Their full data history will load on the charts.</li>
                        <li>Click "Play Simulation" to watch the data playback in real-time.</li>
                        <li>Click "Stop / Reset" to stop playback and clear the charts.</li>
                        <li>Take screenshots of this dashboard for your thesis "Results" section.</li>
                        <li>Click "Download Data" to get the raw JSON for all 3 workers.</li>
                    </ol>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    
                    <!-- Heart Rate Chart -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Heart Rate (BPM)</h3>
                        <div class="chart-container">
                            <canvas id="bpmChart"></canvas>
                        </div>
                    </div>

                    <!-- Blood Oxygen Chart -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Blood Oxygen (SpO2 %)</h3>
                        <div class="chart-container">
                            <canvas id="spo2Chart"></canvas>
                        </div>
                    </div>

                    <!-- Body Temp Chart -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Body Temperature (째C)</h3>
                        <div class="chart-container">
                            <canvas id="tempChart"></canvas>
                        </div>
                    </div>

                    <!-- Stress Level Chart -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Stress Level</h3>
                        <div class="chart-container">
                            <canvas id="stressChart"></canvas>
                        </div>
                    </div>

<!-- Live Location Panel -->
                    <div class="bg-white rounded-lg shadow p-6 xl:col-span-2">
                        <h3 class="text-lg font-semibold text-slate-800 mb-2">Live Location</h3>
                        <h4 class="text-sm font-medium text-slate-600 mb-4">Site Location: GSFC Plant, Moti Khavdi</h4>
                        <div class="map-container">
                            <div id="locationDot" class="location-dot"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2 text-center">Simulated worker movement within the plant area.</p>
                    </div>

                </div>
            </div>

        </div>
    </main>

    <!-- MAIN SCRIPT -->
    <script>
        // === 1. FIXED PRE-RECORDED DATA ===
        // This is the complete, fixed dataset for your thesis.
        // Coordinates are centered on GSFC Plant, Moti Khavdi (approx 22.325째 N, 70.015째 E)
        const fixedRecordedData = {
            'worker-001': [
                // Day 1: 2024-11-22
                { time: "2024-11-22 09:00:00", bpm: 72, spO2: 98, temp: 36.6, stress: "Low", lat: 22.3242, lon: 70.0132 },
                { time: "2024-11-22 09:00:02", bpm: 74, spO2: 98, temp: 36.6, stress: "Low", lat: 22.3242, lon: 70.0133 },
                { time: "2024-11-22 09:00:04", bpm: 75, spO2: 98, temp: 36.7, stress: "Low", lat: 22.3243, lon: 70.0133 },
                { time: "2024-11-22 09:00:06", bpm: 78, spO2: 97, temp: 36.7, stress: "Low", lat: 22.3243, lon: 70.0134 },
                { time: "2024-11-22 09:00:08", bpm: 80, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3244, lon: 70.0134 },
                { time: "2024-11-22 09:00:10", bpm: 82, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3244, lon: 70.0135 },
                { time: "2024-11-22 09:00:12", bpm: 81, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3245, lon: 70.0135 },
                { time: "2024-11-22 09:00:14", bpm: 85, spO2: 97, temp: 36.9, stress: "Medium", lat: 22.3245, lon: 70.0136 },
                // Day 2: 2024-11-23
                { time: "2024-11-23 09:00:16", bpm: 88, spO2: 97, temp: 36.9, stress: "Medium", lat: 22.3246, lon: 70.0136 },
                { time: "2024-11-23 09:00:18", bpm: 86, spO2: 98, temp: 36.8, stress: "Medium", lat: 22.3246, lon: 70.0137 },
                { time: "2024-11-23 09:00:20", bpm: 84, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3247, lon: 70.0137 },
                { time: "2024-11-23 09:00:22", bpm: 82, spO2: 98, temp: 36.7, stress: "Low", lat: 22.3247, lon: 70.0138 },
                { time: "2024-11-23 09:00:24", bpm: 80, spO2: 99, temp: 36.7, stress: "Low", lat: 22.3248, lon: 70.0138 },
                { time: "2024-11-23 09:00:26", bpm: 79, spO2: 99, temp: 36.7, stress: "Low", lat: 22.3248, lon: 70.0139 },
                { time: "2024-1Two-thirds of the file. -23 09:00:28", bpm: 78, spO2: 99, temp: 36.6, stress: "Low", lat: 22.3249, lon: 70.0139 },
                { time: "2024-11-23 09:00:30", bpm: 76, spO2: 98, temp: 36.6, stress: "Low", lat: 22.3249, lon: 70.0140 }
            ],
            'worker-002': [
                // Day 1: 2024-11-25
                { time: "2024-11-25 09:00:00", bpm: 80, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3250, lon: 70.0141 },
                { time: "2024-11-25 09:00:02", bpm: 82, spO2: 98, temp: 36.9, stress: "Low", lat: 22.3250, lon: 70.0142 },
                { time: "2024-11-25 09:00:04", bpm: 85, spO2: 97, temp: 37.0, stress: "Low", lat: 22.3251, lon: 70.0142 },
                { time: "2024-11-25 09:00:06", bpm: 90, spO2: 97, temp: 37.1, stress: "Medium", lat: 22.3251, lon: 70.0143 },
                { time: "2024-11-25 09:00:08", bpm: 95, spO2: 97, temp: 37.2, stress: "Medium", lat: 22.3252, lon: 70.0143 },
                { time: "2024-11-25 09:00:10", bpm: 102, spO2: 96, temp: 37.3, stress: "Medium", lat: 22.3252, lon: 70.0144 },
                { time: "2024-11-25 09:00:12", bpm: 110, spO2: 96, temp: 37.4, stress: "High", lat: 22.3253, lon: 70.0144 },
                { time: "2024-11-25 09:00:14", bpm: 115, spO2: 95, temp: 37.5, stress: "High", lat: 22.3253, lon: 70.0145 },
                // Day 2: 2024-11-26
                { time: "2024-11-26 09:00:16", bpm: 112, spO2: 95, temp: 37.4, stress: "High", lat: 22.3254, lon: 70.0145 },
                { time: "2024-11-26 09:00:18", bpm: 105, spO2: 96, temp: 37.3, stress: "Medium", lat: 22.3254, lon: 70.0146 },
                { time: "2024-11-26 09:00:20", bpm: 100, spO2: 97, temp: 37.2, stress: "Medium", lat: 22.3255, lon: 70.0146 },
                { time: "2024-11-26 09:00:22", bpm: 95, spO2: 97, temp: 37.1, stress: "Low", lat: 22.3255, lon: 70.0147 },
                { time: "2024-11-26 09:00:24", bpm: 92, spO2: 98, temp: 37.0, stress: "Low", lat: 22.3256, lon: 70.0147 },
                { time: "2024-11-26 09:00:26", bpm: 90, spO2: 98, temp: 36.9, stress: "Low", lat: 22.3256, lon: 70.0148 },
                { time: "2024-11-26 09:00:28", bpm: 88, spO2: 98, temp: 36.9, stress: "Low", lat: 22.3257, lon: 70.0148 },
                { time: "2024-11-26 09:00:30", bpm: 86, spO2: 99, temp: 36.8, stress: "Low", lat: 22.3257, lon: 70.0149 }
            ],
            'worker-003': [
                // Day 1: 2024-11-27
                { time: "2024-11-27 09:00:00", bpm: 75, spO2: 99, temp: 36.7, stress: "Low", lat: 22.3245, lon: 70.0136 },
                { time: "2024-11-27 09:00:02", bpm: 74, spO2: 99, temp: 36.7, stress: "Low", lat: 22.3244, lon: 70.0136 },
                { time: "2024-11-27 09:00:04", bpm: 76, spO2: 98, temp: 36.7, stress: "Low", lat: 22.3243, lon: 70.0135 },
                { time: "2024-11-27 09:00:06", bpm: 78, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3242, lon: 70.0135 },
                { time: "2024-11-27 09:00:08", bpm: 80, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3241, lon: 70.0134 },
                { time: "2024-11-27 09:00:10", bpm: 90, spO2: 97, temp: 36.9, stress: "Medium", lat: 22.3240, lon: 70.0134 },
                { time: "2024-11-27 09:00:12", bpm: 88, spO2: 97, temp: 37.0, stress: "Medium", lat: 22.3241, lon: 70.0133 },
                { time: "2024-11-27 09:00:14", bpm: 86, spO2: 98, temp: 36.9, stress: "Medium", lat: 22.3242, lon: 70.0133 },
                // Day 2: 2024-11-28
                { time: "2024-11-28 09:00:16", bpm: 92, spO2: 97, temp: 37.0, stress: "Medium", lat: 22.3243, lon: 70.0132 },
                { time: "2024-11-28 09:00:18", bpm: 95, spO2: 97, temp: 37.1, stress: "Medium", lat: 22.3244, lon: 70.0132 },
                { time: "2024-11-28 09:00:20", bpm: 105, spO2: 96, temp: 37.2, stress: "High", lat: 22.3245, lon: 70.0131 },
                { time: "2024-11-28 09:00:22", bpm: 102, spO2: 96, temp: 37.1, stress: "High", lat: 22.3244, lon: 70.0131 },
                { time: "2024-11-28 09:00:24", bpm: 98, spO2: 97, temp: 37.0, stress: "Medium", lat: 22.3243, lon: 70.0132 },
                { time: "2024-11-28 09:00:26", bpm: 94, spO2: 97, temp: 36.9, stress: "Medium", lat: 22.3242, lon: 70.0132 },
                { time: "2024-11-28 09:00:28", bpm: 90, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3241, lon: 70.0133 },
                { time: "2024-11-28 09:00:30", bpm: 88, spO2: 98, temp: 36.8, stress: "Low", lat: 22.3240, lon: 70.0133 }
            ]
        };

        // Bounds of our simulated map for normalization
        // Centered on GSFC Plant, Moti Khavdi
        const mapBounds = {
            minLat: 22.3240, maxLat: 22.3260,
            minLon: 70.0130, maxLon: 70.0150
        };

        // === 2. STATE MANAGEMENT ===
        let currentState = {
            selectedWorkerId: null,
            simulationInterval: null,
            currentDataIndex: 0,
            isPlaying: false,
        };

        // Chart.js instances
        let charts = {
            bpm: null,
            spo2: null,
            temp: null,
            stress: null
        };

        // DOM Element references
        let elements = {};


        // === 3. CORE FUNCTIONS ===

        /**
         * Initializes all charts with empty data.
         * This function is called once on page load.
         */
        function initCharts() {
            // Destroy old charts if they exist
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            const commonOptions = (title) => ({
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { 
                        type: 'time', // Use time scale
                        time: {
                            tooltipFormat: 'MMM dd, yyyy HH:mm:ss', // Format for the tooltip
                            displayFormats: {
                                second: 'HH:mm:ss',
                                minute: 'HH:mm',
                                hour: 'HH:mm',
                                day: 'MMM dd' 
                            }
                        },
                        title: { display: true, text: 'Date / Time' },
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 10 // Limit ticks to prevent overlap
                        }
                    },
                    y: { 
                        title: { display: true, text: title },
                        beginAtZero: false 
                    }
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                // Custom tooltip title format
                                const date = new Date(tooltipItems[0].parsed.x);
                                return date.toLocaleString('en-US', { 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit', 
                                    second: '2-digit' 
                                });
                            }
                        }
                    }
                },
                animation: { duration: 0 } // No animation on initial load
            });

            // Specific options for SpO2 chart (range 90-100)
            const spo2Options = commonOptions('SpO2 %');
            spo2Options.scales.y.min = 90;
            spo2Options.scales.y.max = 100;
            
            // Specific options for Temp chart (range 35-40)
            const tempOptions = commonOptions('Temperature 째C');
            tempOptions.scales.y.min = 35;
            tempOptions.scales.y.max = 40;

            // Specific options for Stress chart (0=Low, 1=Medium, 2=High)
            const stressOptions = commonOptions('Stress Level');
            stressOptions.scales.y = {
                ...stressOptions.scales.y,
                min: 0,
                max: 2,
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        return ['Low', 'Medium', 'High'][value];
                    }
                }
            };

            // Map stress string to a number
            const stressToNum = (stress) => {
                if (stress === 'High') return 2;
                if (stress === 'Medium') return 1;
                return 0;
            };

            // Get all data for the selected worker
            const workerData = fixedRecordedData[currentState.selectedWorkerId] || [];
            
            // Prepare data for charts
            const allData = {
                labels: workerData.map(d => d.time),
                bpm: workerData.map(d => d.bpm),
                spo2: workerData.map(d => d.spO2),
                temp: workerData.map(d => d.temp),
                stress: workerData.map(d => stressToNum(d.stress))
            };

            // Create charts
            charts.bpm = new Chart(elements.bpmChartCtx, {
                type: 'line',
                data: { labels: allData.labels, datasets: [{ data: allData.bpm, borderColor: '#3B82F6', tension: 0.1, fill: false, pointRadius: 2 }] },
                options: commonOptions('BPM')
            });

            charts.spo2 = new Chart(elements.spo2ChartCtx, {
                type: 'line',
                data: { labels: allData.labels, datasets: [{ data: allData.spo2, borderColor: '#10B981', tension: 0.1, fill: false, pointRadius: 2 }] },
                options: spo2Options
            });

            charts.temp = new Chart(elements.tempChartCtx, {
                type: 'line',
                data: { labels: allData.labels, datasets: [{ data: allData.temp, borderColor: '#F59E0B', tension: 0.1, fill: false, pointRadius: 2 }] },
                options: tempOptions
            });

            charts.stress = new Chart(elements.stressChartCtx, {
                type: 'line',
                data: { labels: allData.labels, datasets: [{ data: allData.stress, borderColor: '#6B7280', tension: 0.1, fill: false, stepped: true, pointRadius: 2 }] },
                options: stressOptions
            });
        }
        
        /**
         * Clears all charts and resets them to an empty state.
         */
        function clearCharts() {
            Object.values(charts).forEach(chart => {
                if(chart) {
                    chart.data.labels = [];
                    chart.data.datasets[0].data = [];
                    chart.update();
                }
            });
            // Re-init empty charts
            const originalWorkerId = currentState.selectedWorkerId;
            currentState.selectedWorkerId = null; // Temporarily set to null
            initCharts();
            currentState.selectedWorkerId = originalWorkerId; // Restore it
        }

        /**
         * Updates the "Live Vitals" panel with the current data point.
         */
        function updateLiveVitals(data) {
            if (!data) {
                elements.liveBpm.textContent = '--';
                elements.liveSpO2.textContent = '--';
                elements.liveTemp.textContent = '--';
                elements.liveStress.textContent = '--';
                elements.liveLat.textContent = 'Lat: --';
                elements.liveLon.textContent = 'Lon: --';
                return;
            }

            elements.liveBpm.textContent = data.bpm;
            elements.liveSpO2.textContent = data.spO2;
            elements.liveTemp.textContent = data.temp.toFixed(1);
            elements.liveStress.textContent = data.stress;
            elements.liveLat.textContent = Lat: ${data.lat.toFixed(4)};
            elements.liveLon.textContent = Lon: ${data.lon.toFixed(4)};
            
            // Update stress color
            elements.liveStress.classList.remove('text-safe-green', 'text-warn-yellow', 'text-danger-red', 'text-slate-800');
            if(data.stress === 'Low') elements.liveStress.classList.add('text-safe-green');
            else if(data.stress === 'Medium') elements.liveStress.classList.add('text-warn-yellow');
            else if(data.stress === 'High') elements.liveStress.classList.add('text-danger-red');
            else elements.liveStress.classList.add('text-slate-800');

            updateLocationDot(data.lat, data.lon);
        }

        /**
         * Updates the position of the dot on the simulated map.
         */
        function updateLocationDot(lat, lon) {
            const { minLat, maxLat, minLon, maxLon } = mapBounds;
            
            // Normalize coordinates to a 0-1 percentage
            const percentX = (lon - minLon) / (maxLon - minLon);
            const percentY = (lat - maxLat) / (minLat - maxLat); // Inverted Y-axis

            // Convert percentage to pixel position within the map container
            const mapRect = elements.mapContainer.getBoundingClientRect();
            const left = percentX * mapRect.width;
            const top = percentY * mapRect.height;

            // Set position (clamped to stay within bounds)
            elements.locationDot.style.left = ${Math.max(8, Math.min(left, mapRect.width - 8))}px;
            elements.locationDot.style.top = ${Math.max(8, Math.min(top, mapRect.height - 8))}px;
        }


        /**
         * Runs one "tick" of the simulation.
         */
        function simulationTick() {
            const data = fixedRecordedData[currentState.selectedWorkerId];
            if (!data) {
                stopSimulation();
                return;
            }

            const currentData = data[currentState.currentDataIndex];
            updateLiveVitals(currentData);
            
            // Highlight the current point on the charts
            Object.values(charts).forEach(chart => {
                chart.setActiveElements([{ datasetIndex: 0, index: currentState.currentDataIndex }]);
                chart.tooltip.setActiveElements([{ datasetIndex: 0, index: currentState.currentDataIndex }]);
                chart.update();
            });


            // Move to the next data point
            currentState.currentDataIndex++;
            if (currentState.currentDataIndex >= data.length) {
                stopSimulation(); // End of data
            }
        }

        /**
         * Starts the data playback simulation.
         */
        function startSimulation() {
            if (currentState.isPlaying || !currentState.selectedWorkerId) return;

            const data = fixedRecordedData[currentState.selectedWorkerId];
            if (!data || data.length === 0) return;

            currentState.isPlaying = true;
            currentState.currentDataIndex = 0; // Start from the beginning
            
            // Update UI
            elements.playButton.disabled = true;
            elements.stopButton.disabled = false;
            elements.workerSelect.disabled = true;
            elements.statusText.textContent = 'Playing...';
            elements.statusIndicator.classList.remove('bg-slate-400', 'bg-warn-yellow');
            elements.statusIndicator.classList.add('bg-safe-green');

            // Start the interval
            simulationTick(); // Run first tick immediately
            currentState.simulationInterval = setInterval(simulationTick, 2000); // Tick every 2 seconds
        }

        /**
         * Stops the simulation and resets the state.
         */
        function stopSimulation() {
            clearInterval(currentState.simulationInterval);
            currentState.simulationInterval = null;
            currentState.isPlaying = false;
            currentState.currentDataIndex = 0;

            // Reset UI
            elements.playButton.disabled = (currentState.selectedWorkerId === null);
            elements.stopButton.disabled = true;
            elements.workerSelect.disabled = false;
            elements.statusText.textContent = 'Paused';
            elements.statusIndicator.classList.remove('bg-safe-green', 'bg-warn-yellow');
            elements.statusIndicator.classList.add('bg-slate-400');

            updateLiveVitals(null); // Clear vitals
            
            // Remove highlights from charts
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.setActiveElements([]);
                    chart.tooltip.setActiveElements([]);
                    chart.update();
                }
            });
            elements.locationDot.style.left = '50%';
            elements.locationDot.style.top = '50%';
        }


        // === 4. EVENT HANDLERS ===

        /**
         * Handles the user changing the worker selection.
         */
        function handleWorkerSelect(event) {
            const workerId = event.target.value;
            stopSimulation(); // Stop any active simulation

            if (workerId) {
                currentState.selectedWorkerId = workerId;
                elements.playButton.disabled = false;
                initCharts(); // Load the full history for this worker
                
                // Show first data point in live view
                const firstData = fixedRecordedData[workerId][0];
                // *** THIS IS THE FINAL FIX: updateLiveVVitals -> updateLiveVitals ***
                updateLiveVitals(firstData);
            } else {
                currentState.selectedWorkerId = null;
                elements.playButton.disabled = true;
                clearCharts();
                updateLiveVitals(null);
            }
        }

        /**
         * Handles the download data button click.
         */
        function handleDownloadData() {
            const dataStr = JSON.stringify(fixedRecordedData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'worker_safety_dataset.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // === 5. INITIALIZATION ===
        
        /**
         * This main function runs once the HTML document is fully loaded.
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Cache DOM elements
            // *** THIS IS THE FINAL FIX: Added missing commas ***
            elements = {
                workerSelect: document.getElementById('workerSelect'),
                playButton: document.getElementById('playButton'),
                stopButton: document.getElementById('stopButton'),
                downloadButton: document.getElementById('downloadButton'),
                statusText: document.getElementById('statusText'),
                statusIndicator: document.getElementById('statusIndicator'),
                liveBpm: document.getElementById('liveBpm'),
                liveSpO2: document.getElementById('liveSpO2'),
                liveTemp: document.getElementById('liveTemp'),
                liveStress: document.getElementById('liveStress'),
                liveLat: document.getElementById('liveLat'),
                liveLon: document.getElementById('liveLon'),
                mapContainer: document.querySelector('.map-container'),
                locationDot: document.getElementById('locationDot'),
                bpmChartCtx: document.getElementById('bpmChart').getContext('2d'),
                spo2ChartCtx: document.getElementById('spo2Chart').getContext('2d'),
                tempChartCtx: document.getElementById('tempChart').getContext('2d'),
                stressChartCtx: document.getElementById('stressChart').getContext('2d')
            };

            // Set up initial state
            initCharts();

            // Attach event listeners
            elements.workerSelect.addEventListener('change', handleWorkerSelect);
            elements.playButton.addEventListener('click', startSimulation);
            elements.stopButton.addEventListener('click', stopSimulation);
            elements.downloadButton.addEventListener('click', handleDownloadData);
        });

    </script>
</body>
</html>
